.tasks-banner-actions {
  margin-top: 0.35rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.agenda-done-info {
  margin-top: 0.2rem;
  font-size: 0.75rem;
  color: var(--text-muted);
}
.agenda-pending-panel {
  margin-bottom: 1rem;
  padding: 0.8rem;
  border-radius: 0.8rem;
  border: 1px solid rgba(148,163,184,0.45);
  background: rgba(15,23,42,0.85);
  display: grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap: 0.8rem;
}
.agenda-pending-column {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}
.agenda-pending-title {
  font-weight: 600;
  font-size: 0.9rem;
}
.agenda-pending-list {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  font-size: 0.85rem;
}
.agenda-pending-item {
  padding: 0.4rem 0.5rem;
  border-radius: 0.6rem;
  background: rgba(56, 189, 248, 0.08);
  border: 1px solid rgba(56,189,248,0.35);
}
.agenda-pending-empty {
  padding: 0.4rem 0.5rem;
  border-radius: 0.6rem;
  background: rgba(15,23,42,0.8);
  border: 1px dashed rgba(148,163,184,0.4);
  color: var(--text-muted);
}
@media (max-width: 900px) {
  .agenda-pending-panel {
    grid-template-columns: minmax(0,1fr);
  }
}
      <div id="tasksBannerGlobal"></div>

            <div id="agendaPendingPanel" class="agenda-pending-panel">
              <div class="agenda-pending-column">
                <div class="agenda-pending-title">Tareas de hoy</div>
                <div id="pendingTodayList" class="agenda-pending-list"></div>
              </div>
              <div class="agenda-pending-column">
                <div class="agenda-pending-title">PrÃ³ximos 7 dÃ­as</div>
                <div id="pendingNext7List" class="agenda-pending-list"></div>
              </div>
            </div>
                Fichajes con objetivo semanal personalizado (Alicia 35 h, MarÃ­a 40 h y resto 40 h por defecto).
                Se guarda fecha, horas y ubicaciÃ³n de inicio.
      { username: "tecnico", password: "tecnico123", role: "tecnico", nombre: "TÃ©cnico", personaKey: "tecnico", objetivoSemanal: 40 }
            normalizeTasksData();
    function normalizeTasksData() {
      ensureTasksArray();
      appState.tasks.forEach(t => {
        if (typeof t.done !== "boolean") t.done = false;
        if (!("doneBy" in t)) t.doneBy = null;
        if (!("doneAt" in t)) t.doneAt = null;
        if (!Array.isArray(t.sharedWith)) t.sharedWith = [];
        if (t.createdBy && !t.sharedWith.includes(t.createdBy)) {
          t.sharedWith.push(t.createdBy);
        }
      });
    }

      if (currentUser && (currentUser.role === "empleado" || currentUser.role === "tecnico")) {
      if (currentUser && (currentUser.role === "empleado" || currentUser.role === "tecnico")) {
          if (!confirm("Â¿Eliminar esta solicitud aprobada del histÃ³rico? Se recalcularÃ¡n automÃ¡ticamente los contadores de vacaciones.")) return;
    const tasksBanner = document.getElementById("tasksBanner");
    const tasksBannerGlobal = document.getElementById("tasksBannerGlobal");
    const pendingTodayList = document.getElementById("pendingTodayList");
    const pendingNext7List = document.getElementById("pendingNext7List");
    const agendaPendingPanel = document.getElementById("agendaPendingPanel");
      normalizeTasksData();
        done: false,
        doneBy: null,
        doneAt: null

              const title = document.createElement("div");
              title.className = "agenda-task-title";
              title.textContent = `${horaText}${t.titulo}`;
              if (t.done) title.classList.add("agenda-task-done");
              item.appendChild(title);

              const meta = document.createElement("div");
              meta.className = "agenda-task-meta";
              meta.textContent = `Creado por ${creatorName}`;
              item.appendChild(meta);

              if (t.done) {
                const info = document.createElement("div");
                info.className = "agenda-done-info";
                const quien = t.doneBy || "Alguien";
                const fechaHecha = formatearFechaHoraCorta(t.doneAt);
                info.textContent = `âœ“ Hecha por ${quien}${fechaHecha ? ` el ${fechaHecha}` : ""}`;
                item.appendChild(info);
              }

              const actions = document.createElement("div");
              actions.style.marginTop = "0.2rem";
              actions.style.display = "flex";
              actions.style.alignItems = "center";
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.checked = !!t.done;
              checkbox.addEventListener("change", () => {
                toggleTaskDone(t.id, checkbox.checked, checkbox);
              });
              const label = document.createElement("span");
              label.style.marginLeft = "0.35rem";
              label.textContent = t.done ? "Marcar como pendiente" : "Marcar como hecha";
              actions.appendChild(checkbox);
              actions.appendChild(label);
              item.appendChild(actions);

        if (t.done) {
          const info = document.createElement("div");
          info.className = "agenda-done-info";
          const quien = t.doneBy || "Alguien";
          const fechaHecha = formatearFechaHoraCorta(t.doneAt);
          info.textContent = `âœ“ Hecha por ${quien}${fechaHecha ? ` el ${fechaHecha}` : ""}`;
          row.appendChild(info);
        }

          toggleTaskDone(t.id, checkbox.checked, checkbox);
        label.textContent = t.done ? "Marcar como pendiente" : "Marcar como hecha";
    function canUserToggleTask(t) {
      if (!currentUser) return false;
      if (currentUser.role === "admin") return true;
      if (t.createdBy === currentUser.username) return true;
      return Array.isArray(t.sharedWith) && t.sharedWith.includes(currentUser.username);
    }

    function formatearFechaHoraCorta(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleString("es-ES", { dateStyle: "medium", timeStyle: "short" });
    }

    function renderPendingTasksList(container, items, emptyText) {
      if (!container) return;
      container.innerHTML = "";
      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "agenda-pending-empty";
        empty.textContent = emptyText;
        container.appendChild(empty);
        return;
      }
      items.slice().sort((a,b) => (a.fecha || "").localeCompare(b.fecha || "")).forEach(t => {
        const div = document.createElement("div");
        div.className = "agenda-pending-item";
        const hora = t.hora ? ` Â· ${t.hora}` : "";
        const fecha = t.fecha ? formatearFechaISOaBonito(t.fecha) : "Sin fecha";
        div.textContent = `${fecha}: ${t.titulo}${hora}`;
        container.appendChild(div);
      });
    }

    function renderTasksBanner(visibles, targetEl, options = {}) {
      const banner = targetEl || document.getElementById("tasksBanner");
      banner.innerHTML = "";
        if (options.showEmpty !== false) {
          const wrap = document.createElement("div");
          wrap.className = "tasks-banner";
          wrap.innerHTML = '<div class="tasks-banner-title">âœ… No tienes tareas pendientes prÃ³ximas.</div>';
          banner.appendChild(wrap);
        }
      const wrap = document.createElement("div");
      wrap.className = "tasks-banner";

      const title = document.createElement("div");
      title.className = "tasks-banner-title";
      title.textContent = "ðŸ”” Tareas pendientes";
      wrap.appendChild(title);
        const section = document.createElement("div");
        section.className = "tasks-banner-section";
        section.innerHTML = '<div class="tasks-banner-item-strong">Para hoy:</div>';
          const item = document.createElement("div");
          item.className = "tasks-banner-item";
          item.textContent = `â€¢ ${t.titulo}${hora}`;
          section.appendChild(item);
        wrap.appendChild(section);
        const section = document.createElement("div");
        section.className = "tasks-banner-section";
        section.innerHTML = '<div class="tasks-banner-item-strong">PrÃ³ximos 7 dÃ­as:</div>';
          const item = document.createElement("div");
          item.className = "tasks-banner-item";
          item.textContent = `â€¢ ${fecha}: ${t.titulo}${hora}`;
          section.appendChild(item);
        wrap.appendChild(section);
      if (options.showButton) {
        const actions = document.createElement("div");
        actions.className = "tasks-banner-actions";
        const btn = document.createElement("button");
        btn.className = "btn btn-primary btn-small";
        btn.textContent = "Ver tareas";
        btn.addEventListener("click", () => setActiveTab("agenda"));
        actions.appendChild(btn);
        wrap.appendChild(actions);
      }

      banner.appendChild(wrap);
    }

    function renderAgendaPending(summary) {
      if (!agendaPendingPanel) return;
      renderPendingTasksList(pendingTodayList, summary.tasksToday, "No tienes tareas pendientes hoy.");
      renderPendingTasksList(pendingNext7List, summary.tasksNext7, "Sin tareas pendientes en los prÃ³ximos 7 dÃ­as.");
    function toggleTaskDone(taskId, done, sourceControl) {
      if (!canUserToggleTask(t)) {
        if (sourceControl) sourceControl.checked = !!t.done;
        alert("No tienes permisos para marcar esta tarea.");
        return;
      }
      t.done = !!done;
      if (t.done) {
        t.doneBy = currentUser ? (currentUser.nombre || currentUser.username) : null;
        t.doneAt = new Date().toISOString();
      } else {
        t.doneBy = null;
        t.doneAt = null;
      }
      const summary = getPendingTasksSummary(visibles);
      renderTasksBanner(visibles, tasksBanner, { showEmpty: true });
      renderTasksBanner(visibles, tasksBannerGlobal, { showEmpty: false, showButton: true });
      renderAgendaPending(summary);
      const resumen = {};
          const key = e.personaKey || e.username || "otro";
          resumen[key] = (resumen[key] || 0) + h;
      return resumen;
      const resumenParts = Object.entries(resumen).map(([key, horas]) => {
        const persona = USERS.find(u => u.personaKey === key || u.username === key);
        const nombre = persona ? (persona.nombre || persona.username) : key;
        return `${nombre}: ${formatDurationHours(horas)}`;
      });
      summaryAdminSemana.textContent = resumenParts.length
        ? resumenParts.join(" Â· ")
        : "Sin fichajes cerrados esta semana.";
          const persona = USERS.find(u => u.personaKey === e.personaKey || u.username === e.username);
          const personaNombre = persona ? (persona.nombre || persona.username) : (e.personaKey || e.username || "Empleado");
    const usernameInput = document.getElementById("username");
      normalizeTasksData();
      const username = usernameInput.value;
