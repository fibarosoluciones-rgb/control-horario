
        <!-- Gesti칩n de usuarios (admin) -->
        <section id="panelUsuarios" class="panel hidden">
          <div class="panel-header">
            <div>
              <h3 class="panel-title">Gesti칩n de usuarios</h3>
              <p class="panel-sub">
                Crea, edita o elimina usuarios. El nombre de usuario debe ser 칰nico. El admin conectado no puede eliminarse.
              </p>
            </div>
            <div class="panel-tag">Administrador</div>
          </div>
          <div class="panel-body">
            <div class="agenda-form" style="gap:0.6rem;">
              <div class="agenda-form-row">
                <div class="field-group">
                  <label class="field-label" for="userUsername">Usuario</label>
                  <input id="userUsername" class="field-input" placeholder="usuario" />
                </div>
                <div class="field-group">
                  <label class="field-label" for="userPassword">Contrase침a</label>
                  <input id="userPassword" class="field-input" type="password" placeholder="solo al crear o cambiar" />
                </div>
                <div class="field-group">
                  <label class="field-label" for="userNombre">Nombre</label>
                  <input id="userNombre" class="field-input" placeholder="Nombre visible" />
                </div>
              </div>
              <div class="agenda-form-row">
                <div class="field-group">
                  <label class="field-label" for="userRole">Rol</label>
                  <select id="userRole" class="field-select">
                    <option value="admin">Admin</option>
                    <option value="empleado">Empleado</option>
                    <option value="tecnico">T칠cnico</option>
                  </select>
                </div>
                <div class="field-group">
                  <label class="field-label" for="userPersonaKey">Persona</label>
                  <input id="userPersonaKey" class="field-input" placeholder="alicia, maria, tecnico..." />
                </div>
                <div class="field-group">
                  <label class="field-label" for="userObjetivo">Objetivo semanal (h)</label>
                  <input id="userObjetivo" type="number" class="field-input" min="0" step="0.5" />
                </div>
                <div class="field-group" style="align-self:flex-end;display:flex;gap:0.5rem;">
                  <label class="field-label" for="userActivo" style="display:flex;align-items:center;gap:0.4rem;">
                    <input type="checkbox" id="userActivo" checked />
                    Activo
                  </label>
                </div>
              </div>
              <div class="agenda-form-row">
                <div class="field-group" style="flex:1;">
                  <label class="field-label" for="userId">ID interno (auto)</label>
                  <input id="userId" class="field-input" readonly placeholder="nuevo usuario" />
                </div>
                <div style="display:flex;align-items:flex-end;gap:0.6rem;">
                  <button id="btnGuardarUsuario" class="btn btn-primary btn-small">游 Guardar usuario</button>
                  <button id="btnNuevoUsuario" class="btn btn-ghost btn-small">Nuevo</button>
                </div>
              </div>
              <div id="userFormError" class="error-msg" style="display:none;"></div>
            </div>

            <div class="log-table-wrapper" style="margin-top:0.8rem;">
              <table class="log-table" id="tablaUsuarios">
                <thead>
                  <tr>
                    <th>Usuario</th>
                    <th>Nombre</th>
                    <th>Rol</th>
                    <th>Persona</th>
                    <th>Objetivo</th>
                    <th>Activo</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>
            <div id="pendingTasksContainer" class="request-list" style="margin-bottom:0.6rem;"></div>
      { username: "admin",  password: "admin123",  role: "admin",    nombre: "Administrador", personaKey: "admin", objetivoSemanal: 40, activo: true },
      { username: "ke침o",   password: "keno123",   role: "admin",    nombre: "Ke침o", personaKey: "admin", objetivoSemanal: 40, activo: true },
      { username: "mejias", password: "mejias123", role: "admin",    nombre: "Mej칤as", personaKey: "admin", objetivoSemanal: 40, activo: true },
      { username: "alicia", password: "alicia123", role: "empleado", nombre: "Alicia", personaKey: "alicia", objetivoSemanal: 35, activo: true },
      { username: "maria",  password: "maria123",  role: "empleado", nombre: "Mar칤a",  personaKey: "maria",  objetivoSemanal: 40, activo: true },
      { username: "tecnico", password: "tecnico123", role: "tecnico", nombre: "T칠cnico", personaKey: "tecnico", objetivoSemanal: 40, activo: true }
    const DEFAULT_USERS = USERS.map(u => ({ ...u }));

    function normalizeUser(u) {
      if (!u) return null;
      return {
        username: u.username,
        password: u.password,
        role: u.role,
        nombre: u.nombre || u.username,
        personaKey: u.personaKey || u.username,
        objetivoSemanal: typeof u.objetivoSemanal === "number" ? u.objetivoSemanal : 40,
        activo: u.activo !== false
      };
    }

          const normalized = normalizeUser(u);
          if (normalized && normalized.username && normalized.password && normalized.role) {
            USERS.push(normalized);
    function ensureDefaultUsers() {
      if (USERS.length === 0) {
        DEFAULT_USERS.forEach(def => USERS.push({ ...def }));
        return;
      }
      const adminDefault = DEFAULT_USERS.find(u => u.username === "admin");
      if (adminDefault && !USERS.find(u => u.username === "admin")) {
        USERS.push({ ...adminDefault });
      }
    }

        const match = USERS.find(u => u.username === parsed.username && u.activo !== false);
      if (currentUser && (currentUser.role === "empleado" || currentUser.role === "tecnico")) {
          if (!confirm("쮼liminar esta solicitud aprobada? Los contadores se recalcular치n autom치ticamente.")) return;
    // Gesti칩n de usuarios (admin)
    // =========================
    const tablaUsuariosBody = document.querySelector("#tablaUsuarios tbody");
    const userIdInput = document.getElementById("userId");
    const userUsernameInput = document.getElementById("userUsername");
    const userPasswordInput = document.getElementById("userPassword");
    const userNombreInput = document.getElementById("userNombre");
    const userRoleSelect = document.getElementById("userRole");
    const userPersonaKeyInput = document.getElementById("userPersonaKey");
    const userObjetivoInput = document.getElementById("userObjetivo");
    const userActivoInput = document.getElementById("userActivo");
    const userFormError = document.getElementById("userFormError");
    const btnGuardarUsuario = document.getElementById("btnGuardarUsuario");
    const btnNuevoUsuario = document.getElementById("btnNuevoUsuario");

    function resetUserForm() {
      if (userIdInput) userIdInput.value = "";
      if (userUsernameInput) userUsernameInput.value = "";
      if (userPasswordInput) userPasswordInput.value = "";
      if (userNombreInput) userNombreInput.value = "";
      if (userRoleSelect) userRoleSelect.value = "empleado";
      if (userPersonaKeyInput) userPersonaKeyInput.value = "";
      if (userObjetivoInput) userObjetivoInput.value = "40";
      if (userActivoInput) userActivoInput.checked = true;
      if (userFormError) {
        userFormError.style.display = "none";
        userFormError.textContent = "";
      }
    }

    function fillUserForm(u) {
      if (!u) return;
      if (userIdInput) userIdInput.value = u.username;
      if (userUsernameInput) userUsernameInput.value = u.username;
      if (userPasswordInput) userPasswordInput.value = "";
      if (userNombreInput) userNombreInput.value = u.nombre || "";
      if (userRoleSelect) userRoleSelect.value = u.role;
      if (userPersonaKeyInput) userPersonaKeyInput.value = u.personaKey || "";
      if (userObjetivoInput) userObjetivoInput.value = typeof u.objetivoSemanal === "number" ? u.objetivoSemanal : "";
      if (userActivoInput) userActivoInput.checked = u.activo !== false;
    }

    function renderTablaUsuarios() {
      if (!tablaUsuariosBody) return;
      tablaUsuariosBody.innerHTML = "";
      USERS.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.nombre || u.username}</td>
          <td>${ROLE_LABELS[u.role] || u.role}</td>
          <td>${u.personaKey || "-"}</td>
          <td>${typeof u.objetivoSemanal === "number" ? u.objetivoSemanal + " h" : "-"}</td>
          <td>${u.activo === false ? "No" : "S칤"}</td>
          <td>
            <button class="btn btn-ghost btn-small" data-action="edit">Editar</button>
            <button class="btn btn-danger btn-small" data-action="delete">Eliminar</button>
          </td>
        `;
        const [btnEdit, btnDelete] = tr.querySelectorAll("button");
        if (btnEdit) {
          btnEdit.addEventListener("click", () => fillUserForm(u));
        }
        if (btnDelete) {
          btnDelete.addEventListener("click", () => {
            if (currentUser && currentUser.username === u.username) {
              alert("No puedes eliminar tu propio usuario activo.");
              return;
            }
            if (!confirm("쮼liminar usuario " + u.username + "?")) return;
            const idx = USERS.findIndex(x => x.username === u.username);
            if (idx >= 0) {
              USERS.splice(idx,1);
              saveUsersToStorage();
              populateSharedWithSelect();
              renderAgenda();
              renderTablaUsuarios();
            }
            if (currentUser && currentUser.username === u.username) {
              currentUser = null;
              saveCurrentUser();
              mostrarLogin();
            }
          });
        }
        tablaUsuariosBody.appendChild(tr);
      });
    }

    function validarUsuarioNuevo(data, isEdit=false) {
      if (!data.username || !data.role) {
        return "Usuario y rol son obligatorios";
      }
      if (!isEdit && !data.password) {
        return "La contrase침a es obligatoria para crear usuario";
      }
      const duplicado = USERS.find(u => u.username === data.username);
      if (!isEdit && duplicado) return "Ya existe un usuario con ese nombre";
      if (isEdit && duplicado && data._original !== data.username) {
        return "No puedes cambiar el usuario a uno que ya existe";
      }
      return null;
    }

    function guardarUsuarioDesdeForm() {
      if (!userUsernameInput || !userRoleSelect) return;
      const username = userUsernameInput.value.trim();
      const password = userPasswordInput ? userPasswordInput.value.trim() : "";
      const nombre = userNombreInput ? userNombreInput.value.trim() : username;
      const role = userRoleSelect.value;
      const personaKey = userPersonaKeyInput ? userPersonaKeyInput.value.trim() : username;
      const objetivo = userObjetivoInput ? parseFloat(userObjetivoInput.value) : 40;
      const activo = userActivoInput ? userActivoInput.checked : true;
      const original = userIdInput ? userIdInput.value : "";

      const data = { username, password, nombre, role, personaKey, objetivoSemanal: isNaN(objetivo) ? 0 : objetivo, activo, _original: original };
      const error = validarUsuarioNuevo(data, !!original);
      if (error) {
        if (userFormError) {
          userFormError.textContent = error;
          userFormError.style.display = "block";
        }
        return;
      }

      let target = USERS.find(u => u.username === (original || username));
      if (!target) {
        target = normalizeUser(data);
        USERS.push(target);
      } else {
        const merged = { ...target, ...data };
        if (!password) merged.password = target.password;
        Object.assign(target, normalizeUser(merged));
        if (password) target.password = password;
      }

      saveUsersToStorage();
      populateSharedWithSelect();
      renderAgenda();
      renderTablaUsuarios();
      if (currentUser && currentUser.username === target.username) {
        currentUser = target;
        saveCurrentUser();
        actualizarUIUsuario();
        updateEmpleadoControlUI();
      }
      resetUserForm();

      if (currentUser && currentUser.username === target.username && target.activo === false) {
        currentUser = null;
        saveCurrentUser();
        mostrarLogin();
      }
    }

    if (btnGuardarUsuario) {
      btnGuardarUsuario.addEventListener("click", guardarUsuarioDesdeForm);
    }
    if (btnNuevoUsuario) {
      btnNuevoUsuario.addEventListener("click", resetUserForm);
    }

    function asegurarPanelUsuarios() {
      if (!currentUser || currentUser.role !== "admin") return;
      renderTablaUsuarios();
    }

    const pendingTasksContainer = document.getElementById("pendingTasksContainer");
        .filter(u => u.username !== currentUser.username && u.activo !== false)
        done: false,
        doneBy: null,
        doneAt: null
      html += '<div style="margin-top:0.4rem;"><button id="btnVerTareas" class="btn btn-primary btn-small">Ver tareas</button></div>';

      const btnVer = document.getElementById("btnVerTareas");
      if (btnVer) {
        btnVer.addEventListener("click", () => setActiveTab("agenda"));
      }
    }

    function renderPendingPanel(visibles) {
      if (!pendingTasksContainer) return;
      const { tasksToday, tasksNext7 } = getPendingTasksSummary(visibles);
      pendingTasksContainer.innerHTML = "";

      if (tasksToday.length === 0 && tasksNext7.length === 0) {
        const empty = document.createElement("div");
        empty.className = "request-card";
        empty.textContent = "No hay tareas pendientes para hoy ni los pr칩ximos 7 d칤as.";
        pendingTasksContainer.appendChild(empty);
        return;
      }

      const buildList = (label, items) => {
        if (!items.length) return;
        const card = document.createElement("div");
        card.className = "request-card";
        const header = document.createElement("div");
        header.className = "request-header";
        header.innerHTML = `<strong>${label}</strong><span class="status-pill status-pendiente">Pendiente</span>`;
        card.appendChild(header);

        items.forEach(t => {
          const row = document.createElement("div");
          row.className = "request-meta";
          const fecha = formatearFechaISOaBonito(t.fecha || hoyISO());
          const hora = t.hora ? t.hora : "--:--";
          row.textContent = `${fecha} 췅 ${hora} 췅 ${t.titulo}`;
          card.appendChild(row);
        });

        pendingTasksContainer.appendChild(card);
      };

      buildList("Pendientes hoy", tasksToday);
      buildList("Pr칩ximos 7 d칤as", tasksNext7);
      if (!t || !currentUser) return;
      const isOwner = t.createdBy === currentUser.username;
      const isShared = Array.isArray(t.sharedWith) && t.sharedWith.includes(currentUser.username);
      const canEdit = currentUser.role === "admin" || isOwner || isShared;
      if (!canEdit) {
        alert("No tienes permiso para cambiar esta tarea.");
        return;
      }
      t.doneBy = done ? (currentUser.nombre || currentUser.username) : null;
      t.doneAt = done ? new Date().toISOString() : null;
      renderPendingPanel(visibles);
    const panelUsuarios = document.getElementById("panelUsuarios");
    function actualizarUIUsuario() {
        if (panelUsuarios) panelUsuarios.classList.remove("hidden");
        if (panelUsuarios) panelUsuarios.classList.add("hidden");
      asegurarPanelUsuarios();
      const user = USERS.find(u => u.username === username && u.password === password && u.activo !== false);
        const exists = USERS.find(u => u.username === username);
        loginError.textContent = exists && exists.activo === false
          ? "Este usuario est치 desactivado. Contacta con un administrador."
          : "Usuario o contrase침a incorrectos.";
      ensureDefaultUsers();
  <!--
    Estructura colecci칩n users:
    - username (string)
    - password (string)
    - role (admin|empleado|tecnico)
    - nombre (string)
    - personaKey (string)
    - objetivoSemanal (number)
    - activo (boolean)

    Estructura documento config/globalState:
    - vacationRequests (array)
    - timeEntries (array)
    - vacationCounters (object)
    - tasks (array)
  -->
