<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control horario - Fibaroteleco</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--muted:#aab3d6;--text:#e9ecff;--accent:#6ee7ff;--danger:#ff6b6b;--ok:#4ade80;--warn:#fbbf24;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#070a14, #0b1020);color:var(--text)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:rgba(11,16,32,.85);backdrop-filter: blur(8px);z-index:10}
    header .brand{font-weight:700;letter-spacing:.3px}
    header .right{display:flex;gap:10px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);color:var(--muted);font-size:12px}
    .container{max-width:1100px;margin:0 auto;padding:14px}
    .grid{display:grid;gap:12px}
    .card{background:rgba(18,26,51,.9);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);color:var(--text);border-radius:10px;padding:10px 10px;font-size:14px;outline:none}
    textarea{min-height:90px;resize:vertical;width:100%}
    button{background:rgba(110,231,255,.14);border:1px solid rgba(110,231,255,.35);color:var(--text);border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer}
    button:hover{filter:brightness(1.06)}
    button.secondary{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    button.danger{background:rgba(255,107,107,.14);border:1px solid rgba(255,107,107,.35)}
    button.ok{background:rgba(74,222,128,.14);border:1px solid rgba(74,222,128,.35)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05);color:var(--muted);cursor:pointer}
    .tab.active{background:rgba(110,231,255,.14);border-color:rgba(110,231,255,.35);color:var(--text)}
    .hidden{display:none !important}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    td{padding:10px;border-top:1px solid rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
    td:first-child{border-left:1px solid rgba(255,255,255,.08);border-top-left-radius:12px;border-bottom-left-radius:12px}
    td:last-child{border-right:1px solid rgba(255,255,255,.08);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .muted{color:var(--muted)}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi .box{flex:1 1 220px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
    .kpi .num{font-size:22px;font-weight:800}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)}
    .badge.ok{border-color:rgba(74,222,128,.35);background:rgba(74,222,128,.12)}
    .badge.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
    .badge.danger{border-color:rgba(255,107,107,.35);background:rgba(255,107,107,.12)}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.two{grid-template-columns:1fr}}
    .small{font-size:12px}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .rightAlign{text-align:right}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
<header>
  <div class="brand">Fibaroteleco ¬∑ Control horario</div>
  <div class="right">
    <span id="netPill" class="pill">‚õÖÔ∏è offline</span>
    <span id="userPill" class="pill">No conectado</span>
    <button id="logoutBtn" class="secondary hidden">Salir</button>
  </div>
</header>

<div class="container">
  <!-- LOGIN -->
  <section id="loginView" class="grid" style="max-width:520px;margin:0 auto;">
    <div class="card">
      <h2 style="margin:0 0 6px 0;">Entrar</h2>
      <div class="muted small">Usa email y contrase√±a (Firebase Auth). Tambi√©n puedes escribir <span class="mono">admin</span>, <span class="mono">maria</span> o <span class="mono">alicia</span> en el campo de email.</div>
      <div class="hr"></div>
      <div class="grid">
        <div>
          <label>Email o usuario</label>
          <input id="emailInput" autocomplete="username" placeholder="admi@fibaroteleco.com" style="width:100%"/>
        </div>
        <div>
          <label>Contrase√±a</label>
          <input id="passInput" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%"/>
        </div>
        <div class="row">
          <button id="loginBtn">Entrar</button>
          <button id="resetPassBtn" class="secondary">Recuperar contrase√±a</button>
        </div>
        <div id="loginMsg" class="muted small"></div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" class="hidden">
    <div class="tabs" style="margin:6px 0 12px 0;">
      <div class="tab active" data-tab="tabSchedule">üìÖ Horario</div>
      <div class="tab" data-tab="tabVacation">üå¥ Vacaciones</div>
      <div class="tab" data-tab="tabTasks">üìÜ Agenda</div>
      <div class="tab" data-tab="tabTime">‚è± Control horario</div>
      <div class="tab hidden" id="adminTabBtn" data-tab="tabAdmin">üõ† Admin</div>
    </div>

    <!-- HORARIO -->
    <section id="tabSchedule" class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h3 style="margin:0;">Horario</h3>
            <div class="muted small">Generado desde el patr√≥n activo. Se muestran 4 semanas desde hoy.</div>
          </div>
          <div class="row">
            <button id="refreshScheduleBtn" class="secondary">Actualizar</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="scheduleGrid" class="grid"></div>
      </div>
    </section>

    <!-- VACACIONES -->
    <section id="tabVacation" class="grid hidden">
      <div class="two">
        <div class="card">
          <h3 style="margin:0;">Solicitar vacaciones</h3>
          <div class="muted small">Las solicitudes se sincronizan en tiempo real.</div>
          <div class="hr"></div>
          <div class="grid">
            <div class="two">
              <div>
                <label>Desde</label>
                <input id="vacFrom" type="date" style="width:100%"/>
              </div>
              <div>
                <label>Hasta</label>
                <input id="vacTo" type="date" style="width:100%"/>
              </div>
            </div>
            <div>
              <label>Comentario (opcional)</label>
              <textarea id="vacComment" placeholder="Motivo, detalles..."></textarea>
            </div>
            <div class="row">
              <button id="vacSubmitBtn">Enviar solicitud</button>
              <span id="vacSubmitMsg" class="muted small"></span>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0;">Mis solicitudes</h3>
          <div class="muted small">Pendientes / aprobadas / rechazadas.</div>
          <div class="hr"></div>
          <div id="myVacList"></div>
        </div>
      </div>

      <div class="card hidden" id="adminVacCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <h3 style="margin:0;">Admin ¬∑ Vacaciones</h3>
            <div class="muted small">Aprobar o rechazar solicitudes.</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="two">
          <div>
            <h4 style="margin:0 0 8px 0;">Pendientes</h4>
            <div id="vacPendingList"></div>
          </div>
          <div>
            <h4 style="margin:0 0 8px 0;">Hist√≥rico</h4>
            <div id="vacHistoryList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="tabTasks" class="grid hidden">
      <div class="two">
        <div class="card">
          <h3 style="margin:0;">Nueva tarea</h3>
          <div class="muted small">Se ve al instante en todos los dispositivos autorizados.</div>
          <div class="hr"></div>
          <div class="grid">
            <div>
              <label>T√≠tulo</label>
              <input id="taskTitle" placeholder="Instalaci√≥n, visita, recordatorio..." style="width:100%"/>
            </div>
            <div class="two">
              <div>
                <label>Fecha</label>
                <input id="taskDate" type="date" style="width:100%"/>
              </div>
              <div>
                <label>Hora (opcional)</label>
                <input id="taskTime" type="time" style="width:100%"/>
              </div>
            </div>
            <div>
              <label>Descripci√≥n (opcional)</label>
              <textarea id="taskDesc"></textarea>
            </div>
            <div>
              <label>Compartir con (opcional)</label>
              <select id="taskShare" multiple style="width:100%;min-height:110px"></select>
              <div class="muted small">Mant√©n pulsado Ctrl/‚åò para seleccionar varios.</div>
            </div>
            <div class="row">
              <button id="taskCreateBtn">Crear</button>
              <span id="taskMsg" class="muted small"></span>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0;">Tareas</h3>
          <div class="muted small">Admin ve todas. Empleados ven las suyas y compartidas.</div>
          <div class="hr"></div>
          <div id="taskList"></div>
        </div>
      </div>
    </section>

    <!-- CONTROL HORARIO -->
    <section id="tabTime" class="grid hidden">
      <div class="two">
        <div class="card">
          <h3 style="margin:0;">Mi jornada</h3>
          <div class="muted small">Se registra ubicaci√≥n en inicio/pausa/reanudar/finalizar (si aceptas permisos).</div>
          <div class="hr"></div>
          <div class="kpi">
            <div class="box">
              <div class="muted small">Estado</div>
              <div id="myStatus" class="num">‚Äî</div>
              <div id="myStatusHint" class="muted small"></div>
            </div>
            <div class="box">
              <div class="muted small">Hoy</div>
              <div id="myToday" class="num">0:00</div>
              <div class="muted small">Horas netas (menos pausas)</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="row">
            <button id="startBtn" class="ok">Iniciar</button>
            <button id="pauseBtn" class="secondary">Pausar</button>
            <button id="resumeBtn" class="secondary">Reanudar</button>
            <button id="endBtn" class="danger">Finalizar</button>
          </div>
          <div id="timeMsg" class="muted small" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h3 style="margin:0;">Mis √∫ltimos fichajes</h3>
          <div class="muted small">√öltimos 14 d√≠as.</div>
          <div class="hr"></div>
          <div id="myTimeList"></div>
        </div>
      </div>

      <div class="card hidden" id="adminTimeCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <h3 style="margin:0;">Admin ¬∑ Control horario</h3>
            <div class="muted small">Estado en tiempo real + resumen semanal y mensual.</div>
          </div>
          <div class="row">
            <button id="exportMonthBtn" class="secondary">Exportar mes (CSV)</button>
          </div>
        </div>
        <div class="hr"></div>

        <div class="two">
          <div>
            <h4 style="margin:0 0 8px 0;">Estado en tiempo real</h4>
            <div id="liveStatus"></div>
          </div>
          <div>
            <h4 style="margin:0 0 8px 0;">Resumen</h4>
            <div class="kpi">
              <div class="box">
                <div class="muted small">Semana actual</div>
                <div id="weekTotal" class="num">0:00</div>
                <div class="muted small">Total equipo</div>
              </div>
              <div class="box">
                <div class="muted small">Mes actual</div>
                <div id="monthTotal" class="num">0:00</div>
                <div class="muted small">Total equipo</div>
              </div>
            </div>
            <div class="hr"></div>
            <div id="summaryByUser"></div>
          </div>
        </div>

        <div class="hr"></div>
        <h4 style="margin:0 0 8px 0;">Fichajes (√∫ltimas 6 semanas)</h4>
        <div id="adminTimeList"></div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="tabAdmin" class="grid hidden">
      <div class="two">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <h3 style="margin:0;">Usuarios</h3>
              <div class="muted small">Editar fichas, horas objetivo, activar/desactivar.</div>
            </div>
            <button id="newPendingBtn" class="secondary">+ Preparar alta</button>
          </div>
          <div class="hr"></div>
          <div id="usersList"></div>
          <div class="hr"></div>
          <h4 style="margin:0 0 8px 0;">Altas pendientes</h4>
          <div class="muted small">Sirve para configurar a alguien antes de que entre por primera vez.</div>
          <div class="hr"></div>
          <div id="pendingList"></div>
        </div>

        <div class="card">
          <h3 style="margin:0;">Turnos</h3>
          <div class="muted small">Crea/edita turnos reutilizables (inicio/fin).</div>
          <div class="hr"></div>
          <div class="grid">
            <div class="two">
              <div>
                <label>Nombre del turno</label>
                <input id="shiftLabel" placeholder="Ma√±ana 1" style="width:100%"/>
              </div>
              <div>
                <label>Descanso (min, opcional)</label>
                <input id="shiftBreak" type="number" min="0" placeholder="0" style="width:100%"/>
              </div>
            </div>
            <div class="two">
              <div>
                <label>Inicio</label>
                <input id="shiftStart" type="time" style="width:100%"/>
              </div>
              <div>
                <label>Fin</label>
                <input id="shiftEnd" type="time" style="width:100%"/>
              </div>
            </div>
            <div class="row">
              <button id="createShiftBtn">Guardar turno</button>
              <span id="shiftMsg" class="muted small"></span>
            </div>
          </div>
          <div class="hr"></div>
          <div id="shiftList"></div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <h3 style="margin:0;">Patrones</h3>
            <div class="muted small">Ciclo flexible (2/3/4‚Ä¶ semanas). Aviso con sonido y doble confirmaci√≥n si descuadra horas.</div>
          </div>
          <div class="row">
            <button id="newPatternBtn" class="secondary">+ Nuevo patr√≥n</button>
            <button id="applyPatternBtn" class="ok">Aplicar patr√≥n</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div style="flex:1 1 320px">
            <label>Patr√≥n activo</label>
            <select id="patternSelect" style="width:100%"></select>
          </div>
          <div style="flex:0 0 160px">
            <label>Ciclo (semanas)</label>
            <input id="cycleWeeks" type="number" min="1" value="2" style="width:100%"/>
          </div>
          <div style="flex:0 0 160px">
            <label>Editar semana</label>
            <select id="weekSelect" style="width:100%"></select>
          </div>
          <div style="flex:0 0 220px">
            <label>Aplicar desde</label>
            <input id="patternEffectiveFrom" type="date" style="width:100%"/>
          </div>
        </div>
        <div class="hr"></div>
        <div id="patternEditor"></div>
        <div class="hr"></div>
        <div id="patternTotals" class="muted small"></div>
      </div>

      <div class="card">
        <h3 style="margin:0;">Auditor√≠a</h3>
        <div class="muted small">Registro de cambios importantes (patrones, usuarios, correcciones de fichajes).</div>
        <div class="hr"></div>
        <div id="auditList"></div>
      </div>
    </section>
  </section>
</div>

<!-- MODALS -->
<div id="modalBackdrop" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50">
  <div class="card" style="max-width:560px;width:100%">
    <h3 id="modalTitle" style="margin:0 0 8px 0">‚Äî</h3>
    <div id="modalBody" class="muted"></div>
    <div class="hr"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="modalCancelBtn" class="secondary">Cancelar</button>
      <button id="modalOkBtn">Aceptar</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase (CDN, sin build)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, sendPasswordResetEmail, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit,
    addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, onSnapshot, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ========= CONFIG =========
  const firebaseConfig = {
    apiKey: "AIzaSyB_DvfW395pemIz9kLZBtCqhQpouHDenYo",
    authDomain: "horarios-84ca8.firebaseapp.com",
    projectId: "horarios-84ca8",
    storageBucket: "horarios-84ca8.firebasestorage.app",
    messagingSenderId: "899817963772",
    appId: "1:899817963772:web:a7a33b7376ab1f9d415779"
  };

  // Alias de login (para escribir "admin", "maria", "alicia")
  const ALIAS_EMAIL = {
    "admin": "admi@fibaroteleco.com",
    "maria": "m.vidal@fibaroteleco.com",
    "alicia": "alicia@fibaroteleco.com"
  };

  const APP = initializeApp(firebaseConfig);
  const AUTH = getAuth(APP);
  const DB = getFirestore(APP);

  // ========= UTIL =========
  const $ = (id)=>document.getElementById(id);
  const fmtHM = (mins)=>{
    const m = Math.max(0, Math.round(mins));
    const h = Math.floor(m/60);
    const r = m%60;
    return `${h}:${String(r).padStart(2,"0")}`;
  };
  const now = ()=> new Date();
  const isoDate = (d)=> {
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const da = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  };
  const startOfDay = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const addDays = (d, n)=> { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const mondayOfWeek = (d)=>{
    const x = startOfDay(d);
    const day = (x.getDay()+6)%7; // Mon=0
    return addDays(x, -day);
  };
  const monthRange = (d)=>{
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth()+1, 1);
    return [start, end];
  };
  const weekRange = (d)=>{
    const start = mondayOfWeek(d);
    const end = addDays(start, 7);
    return [start, end];
  };

  // Firestore no acepta undefined
  const sanitize = (obj)=>{
    if (obj === undefined) return null;
    if (obj === null) return null;
    if (Array.isArray(obj)) return obj.map(sanitize);
    if (typeof obj === "object") {
      const out = {};
      for (const [k,v] of Object.entries(obj)) {
        if (v === undefined) continue;
        out[k] = sanitize(v);
      }
      return out;
    }
    return obj;
  };

  const beep = ()=>{
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type="sine"; o.frequency.value=880;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.12);
      o.start(); o.stop(ctx.currentTime+0.13);
    } catch {}
  };

  // ========= STATE (en memoria, alimentado por snapshots) =========
  const state = {
    me: null, // {uid,email,role,name,weeklyGoalHours,active}
    usersByUid: new Map(),
    tasks: [],
    vacationRequests: [],
    timeEntries: [],
    shifts: [],
    patterns: [],
    activePattern: null,
    settings: { migratedFromGlobalState:false }
  };

  // Snapshot unsubscribers
  const subs = [];

  // ========= UI HELPERS =========
  const show = (el)=>el.classList.remove("hidden");
  const hide = (el)=>el.classList.add("hidden");
  const setMsg = (id, txt)=> { $(id).textContent = txt || ""; };

  // Modal confirm
  let modalResolve = null;
  function openModal({title, body, okText="Aceptar", cancelText="Cancelar"}){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = body;
    $("modalOkBtn").textContent = okText;
    $("modalCancelBtn").textContent = cancelText;
    show($("modalBackdrop"));
    return new Promise((resolve)=>{
      modalResolve = resolve;
    });
  }
  function closeModal(val){
    hide($("modalBackdrop"));
    const r = modalResolve;
    modalResolve = null;
    if (r) r(val);
  }
  $("modalCancelBtn").addEventListener("click", ()=>closeModal(false));
  $("modalOkBtn").addEventListener("click", ()=>closeModal(true));
  $("modalBackdrop").addEventListener("click", (e)=>{ if (e.target === $("modalBackdrop")) closeModal(false); });

  // ========= AUTH =========
  function normalizeEmail(input){
    const raw = (input||"").trim().toLowerCase();
    if (ALIAS_EMAIL[raw]) return ALIAS_EMAIL[raw];
    return raw;
  }

  $("loginBtn").addEventListener("click", async ()=>{
    const email = normalizeEmail($("emailInput").value);
    const pass = $("passInput").value;
    setMsg("loginMsg","");

    if (!email || !pass){ setMsg("loginMsg","Falta email/usuario o contrase√±a."); return; }
    try{
      await signInWithEmailAndPassword(AUTH, email, pass);
    } catch(err){
      console.error(err);
      const msg = (err && err.code) ? err.code : "Error";
      if (msg.includes("user-not-found")) setMsg("loginMsg","Ese usuario no existe en Firebase Auth (cr√©alo en Firebase Authentication).");
      else if (msg.includes("wrong-password") || msg.includes("invalid-credential")) setMsg("loginMsg","Contrase√±a incorrecta.");
      else if (msg.includes("unauthorized-domain")) setMsg("loginMsg","Dominio no autorizado en Firebase Auth (Authorized domains).");
      else setMsg("loginMsg", `No se pudo entrar: ${msg}`);
    }
  });

  $("resetPassBtn").addEventListener("click", async ()=>{
    const email = normalizeEmail($("emailInput").value);
    if (!email){ setMsg("loginMsg","Escribe tu email para enviar recuperaci√≥n."); return; }
    try{
      await sendPasswordResetEmail(AUTH, email);
      setMsg("loginMsg","Te he enviado el email de recuperaci√≥n (si existe).");
    } catch(err){
      console.error(err);
      setMsg("loginMsg","No pude enviar el email (revisa el dominio autorizado o el email).");
    }
  });

  $("logoutBtn").addEventListener("click", async ()=>{
    await signOut(AUTH);
  });

  // ========= NETWORK PILL =========
  function updateNet(){
    $("netPill").textContent = navigator.onLine ? "‚úÖ online" : "‚õÖÔ∏è offline";
  }
  window.addEventListener("online", updateNet);
  window.addEventListener("offline", updateNet);
  updateNet();

  // ========= REALTIME SUBSCRIPTIONS =========
  function clearSubs(){
    while(subs.length) {
      try{ subs.pop()(); } catch {}
    }
  }

  async function ensureSeeds(){
    // settings/app
    const settingsRef = doc(DB, "settings", "app");
    const sSnap = await getDoc(settingsRef);
    if (sSnap.exists()) state.settings = { ...state.settings, ...sSnap.data() };

    // Seed turnos si no hay
    const shiftsRef = collection(DB, "shifts");
    const shiftsSnap = await getDocs(query(shiftsRef, limit(1)));
    if (shiftsSnap.empty){
      const batch = writeBatch(DB);
      const seed = [
        {label:"Ma√±ana 1", start:"08:00", end:"14:00", breakMinutes:0, active:true},
        {label:"Ma√±ana 2", start:"08:00", end:"15:00", breakMinutes:0, active:true},
        {label:"Ma√±ana larga", start:"08:00", end:"16:00", breakMinutes:0, active:true},
        {label:"Tarde 1", start:"14:30", end:"20:30", breakMinutes:0, active:true},
        {label:"Tarde 2", start:"13:30", end:"20:30", breakMinutes:0, active:true},
        {label:"Tarde larga", start:"12:30", end:"20:30", breakMinutes:0, active:true},
        {label:"S√°bado", start:"09:00", end:"14:00", breakMinutes:0, active:true},
        {label:"Libre", start:null, end:null, breakMinutes:0, active:true, isOff:true},
      ];
      for (const sh of seed){
        const r = doc(shiftsRef);
        batch.set(r, sanitize({ ...sh, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }));
      }
      await batch.commit();
    }

    // Seed patr√≥n si no hay
    const patternsRef = collection(DB, "patterns");
    const patSnap = await getDocs(query(patternsRef, limit(1)));
    if (patSnap.empty){
      // Construye un patr√≥n 2 semanas equivalente al actual (A/B) usando etiquetas (se resolver√° a shiftId por label)
      // Nota: asignamos por email inicial; luego el admin puede editar/a√±adir personas.
      const pattern = {
        name: "Patr√≥n base (2 semanas)",
        cycleWeeks: 2,
        effectiveFrom: isoDate(mondayOfWeek(new Date())),
        active: true,
        weeks: [
          { // Semana 1 (A)
            days: [
              { name:"Lunes", assignmentsByEmail: {"alicia@fibaroteleco.com":"Tarde 1","m.vidal@fibaroteleco.com":"Ma√±ana larga"} },
              { name:"Martes", assignmentsByEmail: {"alicia@fibaroteleco.com":"Ma√±ana 1","m.vidal@fibaroteleco.com":"Tarde larga"} },
              { name:"Mi√©rcoles", assignmentsByEmail: {"alicia@fibaroteleco.com":"Tarde 1","m.vidal@fibaroteleco.com":"Ma√±ana larga"} },
              { name:"Jueves", assignmentsByEmail: {"alicia@fibaroteleco.com":"Ma√±ana 1","m.vidal@fibaroteleco.com":"Tarde larga"} },
              { name:"Viernes", assignmentsByEmail: {"alicia@fibaroteleco.com":"Tarde 1","m.vidal@fibaroteleco.com":"Ma√±ana larga"} },
              { name:"S√°bado", assignmentsByEmail: {"alicia@fibaroteleco.com":"S√°bado","m.vidal@fibaroteleco.com":"Libre"} },
              { name:"Domingo", assignmentsByEmail: {"alicia@fibaroteleco.com":"Libre","m.vidal@fibaroteleco.com":"Libre"} },
            ]
          },
          { // Semana 2 (B)
            days: [
              { name:"Lunes", assignmentsByEmail: {"alicia@fibaroteleco.com":"Tarde 2","m.vidal@fibaroteleco.com":"Ma√±ana 2"} },
              { name:"Martes", assignmentsByEmail: {"alicia@fibaroteleco.com":"Ma√±ana 2","m.vidal@fibaroteleco.com":"Tarde 2"} },
              { name:"Mi√©rcoles", assignmentsByEmail: {"alicia@fibaroteleco.com":"Tarde 2","m.vidal@fibaroteleco.com":"Ma√±ana 2"} },
              { name:"Jueves", assignmentsByEmail: {"alicia@fibaroteleco.com":"Ma√±ana 2","m.vidal@fibaroteleco.com":"Tarde 2"} },
              { name:"Viernes", assignmentsByEmail: {"alicia@fibaroteleco.com":"Tarde 2","m.vidal@fibaroteleco.com":"Ma√±ana 2"} },
              { name:"S√°bado", assignmentsByEmail: {"alicia@fibaroteleco.com":"Libre","m.vidal@fibaroteleco.com":"S√°bado"} },
              { name:"Domingo", assignmentsByEmail: {"alicia@fibaroteleco.com":"Libre","m.vidal@fibaroteleco.com":"Libre"} },
            ]
          }
        ]
      };
      await addDoc(patternsRef, sanitize({ ...pattern, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }));
    }
  }

  async function maybeMigrateFromGlobalState(){
    const settingsRef = doc(DB, "settings", "app");
    const sSnap = await getDoc(settingsRef);
    const settings = sSnap.exists() ? sSnap.data() : {};
    if (settings.migratedFromGlobalState) return;

    const oldRef = doc(DB, "config", "globalState");
    const oldSnap = await getDoc(oldRef);
    if (!oldSnap.exists()){
      await setDoc(settingsRef, sanitize({ migratedFromGlobalState:true, migratedAt: serverTimestamp() }), {merge:true});
      return;
    }

    const old = oldSnap.data() || {};
    const batch = writeBatch(DB);

    const tasks = Array.isArray(old.tasks) ? old.tasks : [];
    const vacs = Array.isArray(old.vacationRequests) ? old.vacationRequests : [];
    const times = Array.isArray(old.timeEntries) ? old.timeEntries : [];

    for (const t of tasks){
      const r = doc(collection(DB,"tasks"));
      batch.set(r, sanitize({ ...t, migrated:true, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }));
    }
    for (const v of vacs){
      const r = doc(collection(DB,"vacationRequests"));
      batch.set(r, sanitize({ ...v, migrated:true, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }));
    }
    for (const te of times){
      const r = doc(collection(DB,"timeEntries"));
      batch.set(r, sanitize({ ...te, migrated:true, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }));
    }

    batch.set(settingsRef, sanitize({ migratedFromGlobalState:true, migratedAt: serverTimestamp() }), {merge:true});
    await batch.commit();
  }

  async function upsertUserProfile(firebaseUser){
    const userRef = doc(DB, "users", firebaseUser.uid);
    const snap = await getDoc(userRef);

    // Buscar alta pendiente por email
    let pending = null;
    const pendingQ = query(collection(DB, "pendingUsers"), where("email","==", firebaseUser.email), limit(1));
    const pendingSnap = await getDocs(pendingQ);
    if (!pendingSnap.empty){
      pending = { id: pendingSnap.docs[0].id, ...pendingSnap.docs[0].data() };
    }

    const baseProfile = {
      uid: firebaseUser.uid,
      email: firebaseUser.email,
      name: firebaseUser.displayName || (firebaseUser.email?.split("@")[0] || "Usuario"),
      phone: "",
      role: (firebaseUser.email === "admi@fibaroteleco.com") ? "admin" : "empleado",
      weeklyGoalHours: (firebaseUser.email === "alicia@fibaroteleco.com") ? 35 : 40,
      active: true,
      patternId: null,
      updatedAt: serverTimestamp()
    };

    if (!snap.exists()){
      const merged = { ...baseProfile, ...(pending || {}) };
      delete merged.id;
      await setDoc(userRef, sanitize({ ...merged, createdAt: serverTimestamp() }), {merge:true});
      if (pending) await deleteDoc(doc(DB,"pendingUsers", pending.id));
    } else {
      // Si existe, aplicamos pending si viene (sin pisar a lo loco)
      const current = snap.data() || {};
      const patch = { updatedAt: serverTimestamp() };
      if (pending){
        for (const k of ["name","phone","role","weeklyGoalHours","active","patternId"]){
          if (pending[k] !== undefined && (current[k] === undefined || current[k] === null || current[k] === "")){
            patch[k] = pending[k];
          }
        }
        await deleteDoc(doc(DB,"pendingUsers", pending.id));
      }
      // Asegurar email/uid
      patch.email = firebaseUser.email;
      patch.uid = firebaseUser.uid;
      await setDoc(userRef, sanitize(patch), {merge:true});
    }

    const finalSnap = await getDoc(userRef);
    const me = finalSnap.data();
    state.me = me;
    $("userPill").textContent = `${me.name || me.email} ¬∑ ${me.role}`;
    show($("logoutBtn"));
    if (me.role === "admin") show($("adminTabBtn")); else hide($("adminTabBtn"));
    if (me.role === "admin") show($("adminVacCard")); else hide($("adminVacCard"));
    if (me.role === "admin") show($("adminTimeCard")); else hide($("adminTimeCard"));
  }

  function startRealtime(){
    clearSubs();

    // users
    subs.push(onSnapshot(query(collection(DB,"users"), orderBy("email")), (snap)=>{
      state.usersByUid.clear();
      for (const d of snap.docs){
        state.usersByUid.set(d.id, { id:d.id, ...d.data() });
      }
      renderUserSelects();
      renderUsersAdmin();
      renderSchedule();
      renderSummaries();
      renderLiveStatus();
    }));

    // tasks
    subs.push(onSnapshot(query(collection(DB,"tasks"), orderBy("dateISO","desc"), orderBy("createdAt","desc")), (snap)=>{
      state.tasks = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderTasks();
    }));

    // vacationRequests
    subs.push(onSnapshot(query(collection(DB,"vacationRequests"), orderBy("createdAt","desc")), (snap)=>{
      state.vacationRequests = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderVacations();
      renderSchedule();
    }));

    // timeEntries (√∫ltimas 6 semanas)
    const sixWeeksAgo = addDays(new Date(), -42);
    subs.push(onSnapshot(
      query(collection(DB,"timeEntries"), where("dayISO", ">=", isoDate(sixWeeksAgo)), orderBy("dayISO","desc")),
      (snap)=>{
        state.timeEntries = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderMyTime();
        renderAdminTime();
        renderSummaries();
        renderLiveStatus();
      }
    ));

    // shifts
    subs.push(onSnapshot(query(collection(DB,"shifts"), orderBy("label")), (snap)=>{
      state.shifts = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderShiftAdmin();
      renderSchedule();
      renderPatternEditor();
    }));

    // patterns
    subs.push(onSnapshot(query(collection(DB,"patterns"), orderBy("createdAt","desc")), (snap)=>{
      state.patterns = snap.docs.map(d=>({id:d.id,...d.data()}));
      state.activePattern = state.patterns.find(p=>p.active) || state.patterns[0] || null;
      renderPatternAdmin();
      renderSchedule();
    }));

    // pendingUsers
    subs.push(onSnapshot(query(collection(DB,"pendingUsers"), orderBy("createdAt","desc")), (snap)=>{
      state.pendingUsers = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderPendingAdmin();
    }));

    // auditLogs (√∫ltimos 50)
    subs.push(onSnapshot(query(collection(DB,"auditLogs"), orderBy("at","desc"), limit(50)), (snap)=>{
      state.auditLogs = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderAudit();
    }));
  }

  // ========= PERMISSIONS / LOCATION =========
  function getLocation(){
    return new Promise((resolve)=>{
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            at: new Date().toISOString()
          });
        },
        ()=> resolve(null),
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 10000 }
      );
    });
  }

  // ========= TASKS =========
  function renderUserSelects(){
    // Share select
    const sel = $("taskShare");
    if (!sel) return;
    sel.innerHTML = "";
    for (const u of [...state.usersByUid.values()].filter(x=>x.active!==false)){
      const opt = document.createElement("option");
      opt.value = u.id;
      opt.textContent = `${u.name || u.email} (${u.role})`;
      sel.appendChild(opt);
    }
  }

  function userCanSeeTask(t){
    if (!state.me) return false;
    if (state.me.role === "admin") return true;
    if (t.createdBy === state.me.uid) return true;
    const shared = Array.isArray(t.sharedWith) ? t.sharedWith : [];
    return shared.includes(state.me.uid);
  }

  function renderTasks(){
    const list = $("taskList");
    if (!list) return;
    const tasks = state.tasks.filter(userCanSeeTask);
    if (!tasks.length){ list.innerHTML = '<div class="muted">No hay tareas.</div>'; return; }

    list.innerHTML = tasks.map(t=>{
      const who = state.usersByUid.get(t.createdBy);
      const shared = (t.sharedWith||[]).map(uid=>state.usersByUid.get(uid)?.name || "‚Äî").join(", ");
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(t.title||"(sin t√≠tulo)")}</div>
              <div class="muted small">${escapeHtml(t.dateISO||"")} ${escapeHtml(t.time||"")} ¬∑ por ${escapeHtml(who?.name || who?.email || "‚Äî")}</div>
              ${t.description ? `<div class="small" style="margin-top:6px">${escapeHtml(t.description)}</div>` : ""}
              ${shared ? `<div class="muted small" style="margin-top:6px">Compartido con: ${escapeHtml(shared)}</div>` : ""}
            </div>
            <div class="row">
              ${(state.me.role==="admin" || t.createdBy===state.me.uid) ? `<button class="danger" data-del-task="${t.id}">Borrar</button>` : ""}
            </div>
          </div>
        </div>`;
    }).join("");

    list.querySelectorAll("[data-del-task]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del-task");
        const ok = await openModal({title:"Borrar tarea", body:"¬øSeguro que quieres borrar esta tarea?", okText:"Borrar"});
        if (!ok) return;
        await deleteDoc(doc(DB,"tasks", id));
      });
    });
  }

  $("taskCreateBtn").addEventListener("click", async ()=>{
    if (!state.me) return;
    const title = $("taskTitle").value.trim();
    const dateISO = $("taskDate").value;
    if (!title || !dateISO){ setMsg("taskMsg","Falta t√≠tulo o fecha."); return; }
    const time = $("taskTime").value || "";
    const description = $("taskDesc").value.trim();
    const sharedWith = Array.from($("taskShare").selectedOptions).map(o=>o.value);

    await addDoc(collection(DB,"tasks"), sanitize({
      title, dateISO, time, description,
      sharedWith,
      createdBy: state.me.uid,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }));

    $("taskTitle").value = "";
    $("taskTime").value = "";
    $("taskDesc").value = "";
    setMsg("taskMsg","Creada.");
    setTimeout(()=>setMsg("taskMsg",""), 1500);
  });

  // ========= VACATIONS =========
  function renderVacations(){
    const my = $("myVacList");
    const pending = $("vacPendingList");
    const hist = $("vacHistoryList");
    if (!my) return;

    const mine = state.vacationRequests.filter(v=>v.uid===state.me.uid).slice(0,50);
    my.innerHTML = mine.length ? mine.map(renderVacCard).join("") : '<div class="muted">Sin solicitudes.</div>';

    if (state.me.role === "admin"){
      const pend = state.vacationRequests.filter(v=>v.status==="pendiente");
      const history = state.vacationRequests.filter(v=>v.status!=="pendiente");
      pending.innerHTML = pend.length ? pend.map(v=>renderVacCard(v,true)).join("") : '<div class="muted">Nada pendiente.</div>';
      hist.innerHTML = history.length ? history.slice(0,30).map(v=>renderVacCard(v,false)).join("") : '<div class="muted">Sin hist√≥rico.</div>';

      // attach buttons
      document.querySelectorAll("[data-vac-approve]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-vac-approve");
          await updateDoc(doc(DB,"vacationRequests", id), sanitize({
            status:"aprobada",
            managedBy: state.me.uid,
            managedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }));
        });
      });
      document.querySelectorAll("[data-vac-reject]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-vac-reject");
          await updateDoc(doc(DB,"vacationRequests", id), sanitize({
            status:"rechazada",
            managedBy: state.me.uid,
            managedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }));
        });
      });
    }
  }

  function renderVacCard(v, withButtons=false){
    const user = state.usersByUid.get(v.uid);
    const who = user?.name || user?.email || v.email || "‚Äî";
    const badge = v.status==="aprobada" ? "ok" : v.status==="rechazada" ? "danger" : "warn";
    const statusLabel = v.status || "pendiente";
    return `
      <div class="card" style="padding:10px;margin-bottom:10px">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:800">${escapeHtml(who)}</div>
            <div class="muted small">${escapeHtml(v.fromDate)} ‚Üí ${escapeHtml(v.toDate)}</div>
            ${v.comment ? `<div class="small" style="margin-top:6px">${escapeHtml(v.comment)}</div>` : ""}
          </div>
          <div style="text-align:right">
            <div class="badge ${badge}">${escapeHtml(statusLabel)}</div>
            ${withButtons ? `
              <div class="row" style="justify-content:flex-end;margin-top:8px">
                <button class="ok" data-vac-approve="${v.id}">Aprobar</button>
                <button class="danger" data-vac-reject="${v.id}">Rechazar</button>
              </div>` : ""}
          </div>
        </div>
      </div>`;
  }

  $("vacSubmitBtn").addEventListener("click", async ()=>{
    if (!state.me) return;
    const fromDate = $("vacFrom").value;
    const toDate = $("vacTo").value;
    const comment = $("vacComment").value.trim();
    if (!fromDate || !toDate){ setMsg("vacSubmitMsg","Faltan fechas."); return; }
    if (toDate < fromDate){ setMsg("vacSubmitMsg","La fecha 'hasta' no puede ser anterior."); return; }

    await addDoc(collection(DB,"vacationRequests"), sanitize({
      uid: state.me.uid,
      email: state.me.email,
      fromDate, toDate,
      comment,
      status: "pendiente",
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }));

    $("vacFrom").value = "";
    $("vacTo").value = "";
    $("vacComment").value = "";
    setMsg("vacSubmitMsg","Enviada.");
    setTimeout(()=>setMsg("vacSubmitMsg",""), 1500);
  });

  function isOnVacation(uid, dayISO){
    const d = dayISO;
    return state.vacationRequests.some(v=>v.uid===uid && v.status==="aprobada" && v.fromDate<=d && v.toDate>=d);
  }

  // ========= TIME TRACKING =========
  async function getOpenEntryToday(){
    const qy = query(collection(DB,"timeEntries"),
      where("uid","==", state.me.uid),
      where("dayISO","==", isoDate(new Date())),
      where("status","==", "open"),
      limit(1)
    );
    const snap = await getDocs(qy);
    if (snap.empty) return null;
    const d = snap.docs[0];
    return { id:d.id, ...d.data() };
  }

  function calcNetMinutes(entry){
    const start = entry.startAt?.toDate ? entry.startAt.toDate() : (entry.startAt ? new Date(entry.startAt) : null);
    const end = entry.endAt?.toDate ? entry.endAt.toDate() : (entry.endAt ? new Date(entry.endAt) : null);
    const nowD = new Date();
    const endUse = end || nowD;
    if (!start) return 0;
    let mins = (endUse - start)/60000;
    const pauses = Array.isArray(entry.pauses) ? entry.pauses : [];
    for (const p of pauses){
      const ps = p.startAt?.toDate ? p.startAt.toDate() : (p.startAt ? new Date(p.startAt) : null);
      const pe = p.endAt?.toDate ? p.endAt.toDate() : (p.endAt ? new Date(p.endAt) : null);
      if (ps){
        mins -= ((pe || nowD) - ps)/60000;
      }
    }
    return Math.max(0, mins);
  }

  async function updateMyStatusUI(){
    const open = state.timeEntries.find(te=>te.uid===state.me.uid && te.dayISO===isoDate(new Date()) && te.status==="open") || null;
    if (!open){
      $("myStatus").textContent = "Fuera";
      $("myStatusHint").textContent = "No hay jornada abierta hoy.";
      $("myToday").textContent = "0:00";
      $("startBtn").disabled = false;
      $("pauseBtn").disabled = true;
      $("resumeBtn").disabled = true;
      $("endBtn").disabled = true;
      return;
    }
    const paused = !!open.paused;
    $("myStatus").textContent = paused ? "Pausa" : "Trabajando";
    $("myStatusHint").textContent = paused ? "Jornada abierta y en pausa." : "Jornada abierta.";
    $("myToday").textContent = fmtHM(calcNetMinutes(open));
    $("startBtn").disabled = true;
    $("pauseBtn").disabled = paused;
    $("resumeBtn").disabled = !paused;
    $("endBtn").disabled = false;
  }

  async function appendEvent(entryId, type){
    const loc = await getLocation();
    const ev = { type, at: new Date().toISOString(), loc };
    return { ev, loc };
  }

  $("startBtn").addEventListener("click", async ()=>{
    if (!state.me) return;
    setMsg("timeMsg","");
    const existing = await getOpenEntryToday();
    if (existing){ setMsg("timeMsg","Ya hay una jornada abierta hoy."); return; }

    const {ev, loc} = await appendEvent(null, "start");
    await addDoc(collection(DB,"timeEntries"), sanitize({
      uid: state.me.uid,
      email: state.me.email,
      dayISO: isoDate(new Date()),
      status: "open",
      paused: false,
      startAt: new Date().toISOString(),
      endAt: null,
      pauses: [],
      events: [ev],
      ubicacionInicio: loc,
      ubicacionFin: null,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }));
    setMsg("timeMsg","Jornada iniciada.");
  });

  $("pauseBtn").addEventListener("click", async ()=>{
    const open = state.timeEntries.find(te=>te.uid===state.me.uid && te.dayISO===isoDate(new Date()) && te.status==="open");
    if (!open){ setMsg("timeMsg","No hay jornada abierta."); return; }
    if (open.paused){ setMsg("timeMsg","Ya est√°s en pausa."); return; }

    const {ev, loc} = await appendEvent(open.id, "pause");
    const pauses = Array.isArray(open.pauses) ? [...open.pauses] : [];
    pauses.push({ startAt: new Date().toISOString(), endAt: null, locStart: loc, locEnd: null });
    await updateDoc(doc(DB,"timeEntries", open.id), sanitize({
      paused: true,
      pauses,
      events: [...(open.events||[]), ev],
      updatedAt: serverTimestamp()
    }));
    setMsg("timeMsg","Pausa iniciada.");
  });

  $("resumeBtn").addEventListener("click", async ()=>{
    const open = state.timeEntries.find(te=>te.uid===state.me.uid && te.dayISO===isoDate(new Date()) && te.status==="open");
    if (!open){ setMsg("timeMsg","No hay jornada abierta."); return; }
    if (!open.paused){ setMsg("timeMsg","No est√°s en pausa."); return; }

    const {ev, loc} = await appendEvent(open.id, "resume");
    const pauses = Array.isArray(open.pauses) ? [...open.pauses] : [];
    // cerrar la √∫ltima pausa sin fin
    for (let i=pauses.length-1;i>=0;i--){
      if (!pauses[i].endAt){
        pauses[i] = { ...pauses[i], endAt: new Date().toISOString(), locEnd: loc };
        break;
      }
    }
    await updateDoc(doc(DB,"timeEntries", open.id), sanitize({
      paused: false,
      pauses,
      events: [...(open.events||[]), ev],
      updatedAt: serverTimestamp()
    }));
    setMsg("timeMsg","Reanudada.");
  });

  $("endBtn").addEventListener("click", async ()=>{
    const open = state.timeEntries.find(te=>te.uid===state.me.uid && te.dayISO===isoDate(new Date()) && te.status==="open");
    if (!open){ setMsg("timeMsg","No hay jornada abierta."); return; }
    const {ev, loc} = await appendEvent(open.id, "end");

    // cerrar pausa si estaba abierta
    const pauses = Array.isArray(open.pauses) ? [...open.pauses] : [];
    for (let i=pauses.length-1;i>=0;i--){
      if (!pauses[i].endAt){
        pauses[i] = { ...pauses[i], endAt: new Date().toISOString(), locEnd: loc };
        break;
      }
    }

    await updateDoc(doc(DB,"timeEntries", open.id), sanitize({
      status:"closed",
      paused:false,
      endAt: new Date().toISOString(),
      pauses,
      events: [...(open.events||[]), ev],
      ubicacionFin: loc,
      updatedAt: serverTimestamp()
    }));
    setMsg("timeMsg","Jornada finalizada.");
  });

  function renderMyTime(){
    updateMyStatusUI();
    const list = $("myTimeList");
    if (!list) return;
    const mine = state.timeEntries.filter(te=>te.uid===state.me.uid).slice(0,14);
    if (!mine.length){ list.innerHTML = '<div class="muted">Sin fichajes.</div>'; return; }
    list.innerHTML = mine.map(te=>{
      const net = fmtHM(calcNetMinutes(te));
      const badge = te.status==="open" ? (te.paused ? "warn" : "ok") : "";
      const status = te.status==="open" ? (te.paused ? "en pausa" : "abierta") : "cerrada";
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(te.dayISO)}</div>
              <div class="muted small">Estado: ${escapeHtml(status)} ¬∑ Neto: ${net}</div>
            </div>
            <div><span class="badge ${badge}">${escapeHtml(net)}</span></div>
          </div>
        </div>`;
    }).join("");
  }

  function renderLiveStatus(){
    const box = $("liveStatus");
    if (!box) return;
    if (!state.me || state.me.role!=="admin"){ box.innerHTML=""; return; }

    const open = state.timeEntries.filter(te=>te.status==="open");
    const rows = [...state.usersByUid.values()].filter(u=>u.active!==false).map(u=>{
      const te = open.find(x=>x.uid===u.id);
      let status = "Fuera";
      let badge = "";
      if (te){
        status = te.paused ? "Pausa" : "Trabajando";
        badge = te.paused ? "warn" : "ok";
      }
      return {u, status, badge, te};
    });

    box.innerHTML = rows.map(r=>{
      const net = r.te ? fmtHM(calcNetMinutes(r.te)) : "0:00";
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(r.u.name || r.u.email)}</div>
              <div class="muted small">${escapeHtml(r.status)} ¬∑ Hoy: ${net}</div>
            </div>
            <span class="badge ${r.badge}">${escapeHtml(r.status)}</span>
          </div>
        </div>`;
    }).join("");
  }

  function renderAdminTime(){
    if (!state.me || state.me.role!=="admin") return;
    const list = $("adminTimeList");
    if (!list) return;

    const entries = state.timeEntries.slice(0,200);
    if (!entries.length){ list.innerHTML = '<div class="muted">Sin fichajes.</div>'; return; }
    list.innerHTML = entries.map(te=>{
      const u = state.usersByUid.get(te.uid);
      const who = u?.name || u?.email || te.email || te.uid;
      const net = fmtHM(calcNetMinutes(te));
      const st = te.status==="open" ? (te.paused ? "abierta (pausa)" : "abierta") : "cerrada";
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(who)} ¬∑ ${escapeHtml(te.dayISO)}</div>
              <div class="muted small">Estado: ${escapeHtml(st)} ¬∑ Neto: ${net}</div>
            </div>
          </div>
        </div>`;
    }).join("");
  }

  function renderSummaries(){
    if (!state.me || state.me.role!=="admin") return;

    const [ws,we] = weekRange(new Date());
    const [ms,me] = monthRange(new Date());

    const weekStartISO = isoDate(ws);
    const weekEndISO = isoDate(addDays(we,-1));
    const monthStartISO = isoDate(ms);
    const monthEndISO = isoDate(addDays(me,-1));

    const activeUsers = [...state.usersByUid.values()].filter(u=>u.active!==false);

    const totals = {};
    for (const u of activeUsers) totals[u.id] = {week:0, month:0, goal:u.weeklyGoalHours||0};

    for (const te of state.timeEntries){
      if (te.status !== "closed" && te.status !== "open") continue;
      const m = calcNetMinutes(te);
      if (te.dayISO >= weekStartISO && te.dayISO <= weekEndISO) (totals[te.uid] ||= {week:0,month:0,goal:0}).week += m;
      if (te.dayISO >= monthStartISO && te.dayISO <= monthEndISO) (totals[te.uid] ||= {week:0,month:0,goal:0}).month += m;
    }

    const weekTotalMin = Object.values(totals).reduce((a,x)=>a+x.week,0);
    const monthTotalMin = Object.values(totals).reduce((a,x)=>a+x.month,0);

    $("weekTotal").textContent = fmtHM(weekTotalMin);
    $("monthTotal").textContent = fmtHM(monthTotalMin);

    const list = $("summaryByUser");
    list.innerHTML = activeUsers.map(u=>{
      const t = totals[u.id] || {week:0,month:0,goal:0};
      const goalMin = (u.weeklyGoalHours||0)*60;
      const diff = t.week - goalMin;
      const badge = diff>=0 ? "ok" : "warn";
      const diffTxt = diff>=0 ? `+${fmtHM(diff)}` : `-${fmtHM(-diff)}`;
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(u.name || u.email)}</div>
              <div class="muted small">Semana: ${fmtHM(t.week)} / Objetivo: ${fmtHM(goalMin)} (${diffTxt})</div>
              <div class="muted small">Mes: ${fmtHM(t.month)}</div>
            </div>
            <span class="badge ${badge}">${escapeHtml(diffTxt)}</span>
          </div>
        </div>`;
    }).join("");
  }

  // Export CSV mes actual (admin)
  $("exportMonthBtn").addEventListener("click", ()=>{
    if (!state.me || state.me.role!=="admin") return;
    const [ms,me] = monthRange(new Date());
    const monthStartISO = isoDate(ms);
    const monthEndISO = isoDate(addDays(me,-1));
    const rows = [["uid","nombre","email","dia","estado","minutos_netos"]];
    for (const te of state.timeEntries){
      if (te.dayISO < monthStartISO || te.dayISO > monthEndISO) continue;
      const u = state.usersByUid.get(te.uid);
      rows.push([te.uid, u?.name||"", u?.email||te.email||"", te.dayISO, te.status||"", String(Math.round(calcNetMinutes(te)))]);
    }
    downloadCSV(`fichajes_${monthStartISO}_a_${monthEndISO}.csv`, rows);
  });

  function downloadCSV(filename, rows){
    const csv = rows.map(r=>r.map(x=>{
      const s = String(x ?? "");
      if (s.includes('"') || s.includes(",") || s.includes("\n")) return '"' + s.replaceAll('"','""') + '"';
      return s;
    }).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ========= ADMIN: USERS =========
  function renderUsersAdmin(){
    const box = $("usersList");
    if (!box || !state.me || state.me.role!=="admin") return;
    const users = [...state.usersByUid.values()].sort((a,b)=>(a.email||"").localeCompare(b.email||""));
    box.innerHTML = users.map(u=>{
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div style="font-weight:800">${escapeHtml(u.name || u.email)}</div>
              <div class="muted small">${escapeHtml(u.email||"")} ¬∑ ${escapeHtml(u.phone||"‚Äî")}</div>
              <div class="muted small">Rol: ${escapeHtml(u.role||"empleado")} ¬∑ Objetivo: ${escapeHtml(String(u.weeklyGoalHours||0))}h ¬∑ ${u.active===false ? "INACTIVO" : "ACTIVO"}</div>
            </div>
            <button class="secondary" data-edit-user="${u.id}">Editar</button>
          </div>
        </div>`;
    }).join("");

    box.querySelectorAll("[data-edit-user]").forEach(btn=>{
      btn.addEventListener("click", ()=>openUserEditor(btn.getAttribute("data-edit-user")));
    });
  }

  async function openUserEditor(uid){
    const u = state.usersByUid.get(uid);
    if (!u) return;
    const body = `
      <div class="grid">
        <div><label>Nombre</label><input id="m_name" value="${escapeAttr(u.name||"")}" style="width:100%"/></div>
        <div><label>Tel√©fono</label><input id="m_phone" value="${escapeAttr(u.phone||"")}" style="width:100%"/></div>
        <div><label>Email</label><input id="m_email" value="${escapeAttr(u.email||"")}" style="width:100%" disabled/></div>
        <div class="two">
          <div><label>Rol</label>
            <select id="m_role" style="width:100%">
              ${["admin","empleado","tecnico"].map(r=>`<option ${u.role===r?"selected":""} value="${r}">${r}</option>`).join("")}
            </select>
          </div>
          <div><label>Horas objetivo / semana</label><input id="m_goal" type="number" min="0" value="${escapeAttr(String(u.weeklyGoalHours||0))}" style="width:100%"/></div>
        </div>
        <div><label>Activo</label>
          <select id="m_active" style="width:100%">
            <option value="true" ${u.active!==false?"selected":""}>S√≠</option>
            <option value="false" ${u.active===false?"selected":""}>No</option>
          </select>
        </div>
      </div>`;
    const ok = await openModal({title:"Editar usuario", body, okText:"Guardar"});
    if (!ok) return;

    const patch = {
      name: document.getElementById("m_name").value.trim(),
      phone: document.getElementById("m_phone").value.trim(),
      role: document.getElementById("m_role").value,
      weeklyGoalHours: Number(document.getElementById("m_goal").value || 0),
      active: document.getElementById("m_active").value === "true",
      updatedAt: serverTimestamp()
    };
    await setDoc(doc(DB,"users", uid), sanitize(patch), {merge:true});
    await addDoc(collection(DB,"auditLogs"), sanitize({ at: serverTimestamp(), who: state.me.uid, action:"user_update", targetUid: uid, patch }));
  }

  $("newPendingBtn").addEventListener("click", async ()=>{
    if (!state.me || state.me.role!=="admin") return;
    const body = `
      <div class="grid">
        <div><label>Email</label><input id="p_email" placeholder="nuevo@fibaroteleco.com" style="width:100%"/></div>
        <div><label>Nombre</label><input id="p_name" placeholder="Nombre Apellido" style="width:100%"/></div>
        <div><label>Tel√©fono</label><input id="p_phone" placeholder="" style="width:100%"/></div>
        <div class="two">
          <div><label>Rol</label>
            <select id="p_role" style="width:100%">
              <option value="empleado">empleado</option>
              <option value="tecnico">tecnico</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div><label>Horas objetivo/semana</label><input id="p_goal" type="number" min="0" value="40" style="width:100%"/></div>
        </div>
      </div>`;
    const ok = await openModal({title:"Preparar alta (ficha)", body, okText:"Guardar"});
    if (!ok) return;

    const email = document.getElementById("p_email").value.trim().toLowerCase();
    if (!email){ return; }
    await addDoc(collection(DB,"pendingUsers"), sanitize({
      email,
      name: document.getElementById("p_name").value.trim(),
      phone: document.getElementById("p_phone").value.trim(),
      role: document.getElementById("p_role").value,
      weeklyGoalHours: Number(document.getElementById("p_goal").value||0),
      active: true,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }));
    await addDoc(collection(DB,"auditLogs"), sanitize({ at: serverTimestamp(), who: state.me.uid, action:"pending_create", email }));
  });

  function renderPendingAdmin(){
    const box = $("pendingList");
    if (!box || !state.me || state.me.role!=="admin") return;
    const pend = state.pendingUsers || [];
    if (!pend.length){ box.innerHTML = '<div class="muted">No hay altas pendientes.</div>'; return; }
    box.innerHTML = pend.map(p=>{
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(p.email)}</div>
              <div class="muted small">${escapeHtml(p.name||"")} ¬∑ ${escapeHtml(String(p.weeklyGoalHours||0))}h ¬∑ ${escapeHtml(p.role||"empleado")}</div>
            </div>
            <button class="danger" data-del-pending="${p.id}">Borrar</button>
          </div>
        </div>`;
    }).join("");
    box.querySelectorAll("[data-del-pending]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del-pending");
        const ok = await openModal({title:"Borrar alta pendiente", body:"¬øSeguro?", okText:"Borrar"});
        if (!ok) return;
        await deleteDoc(doc(DB,"pendingUsers", id));
      });
    });
  }

  // ========= ADMIN: SHIFTS =========
  $("createShiftBtn").addEventListener("click", async ()=>{
    if (!state.me || state.me.role!=="admin") return;
    const label = $("shiftLabel").value.trim();
    const start = $("shiftStart").value || null;
    const end = $("shiftEnd").value || null;
    const breakMinutes = Number($("shiftBreak").value||0);
    if (!label){ setMsg("shiftMsg","Falta nombre."); return; }
    await addDoc(collection(DB,"shifts"), sanitize({
      label, start, end, breakMinutes, active:true,
      createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    }));
    $("shiftLabel").value = "";
    $("shiftStart").value = "";
    $("shiftEnd").value = "";
    $("shiftBreak").value = "";
    setMsg("shiftMsg","Guardado.");
    setTimeout(()=>setMsg("shiftMsg",""), 1500);
  });

  function shiftDurationMinutes(sh){
    if (!sh || sh.isOff || !sh.start || !sh.end) return 0;
    const [shh,smm] = sh.start.split(":").map(Number);
    const [ehh,emm] = sh.end.split(":").map(Number);
    const s = shh*60+smm;
    const e = ehh*60+emm;
    return Math.max(0, e - s - (Number(sh.breakMinutes||0)));
  }

  function renderShiftAdmin(){
    const box = $("shiftList");
    if (!box || !state.me || state.me.role!=="admin") return;
    const list = state.shifts.slice();
    box.innerHTML = list.map(sh=>{
      const dur = fmtHM(shiftDurationMinutes(sh));
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">${escapeHtml(sh.label)}</div>
              <div class="muted small">${sh.start && sh.end ? `${escapeHtml(sh.start)}‚Äì${escapeHtml(sh.end)} ¬∑ ${dur}` : "Sin horas (Libre)"} </div>
            </div>
            <button class="danger" data-del-shift="${sh.id}">Borrar</button>
          </div>
        </div>`;
    }).join("");
    box.querySelectorAll("[data-del-shift]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del-shift");
        const ok = await openModal({title:"Borrar turno", body:"Si un patr√≥n usa este turno, quedar√° vac√≠o. ¬øBorrar?", okText:"Borrar"});
        if (!ok) return;
        await deleteDoc(doc(DB,"shifts", id));
        await addDoc(collection(DB,"auditLogs"), sanitize({ at: serverTimestamp(), who: state.me.uid, action:"shift_delete", shiftId:id }));
      });
    });
  }

  // ========= ADMIN: PATTERNS =========
  function renderPatternAdmin(){
    const sel = $("patternSelect");
    if (!sel || !state.me || state.me.role!=="admin") return;
    sel.innerHTML = "";
    for (const p of state.patterns){
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.active ? `${p.name} (activo)` : p.name;
      if (state.activePattern && p.id === state.activePattern.id) opt.selected = true;
      sel.appendChild(opt);
    }
    $("patternEffectiveFrom").value = state.activePattern?.effectiveFrom || isoDate(mondayOfWeek(new Date()));
    $("cycleWeeks").value = String(state.activePattern?.cycleWeeks || 2);
    buildWeekSelect();
    renderPatternEditor();
  }

  function buildWeekSelect(){
    const cycle = Number($("cycleWeeks").value || state.activePattern?.cycleWeeks || 2);
    const ws = $("weekSelect");
    ws.innerHTML = "";
    for (let i=0;i<cycle;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `Semana ${i+1}`;
      ws.appendChild(opt);
    }
  }

  $("patternSelect").addEventListener("change", ()=>{
    const id = $("patternSelect").value;
    state.activePattern = state.patterns.find(p=>p.id===id) || null;
    renderPatternAdmin();
  });
  $("cycleWeeks").addEventListener("change", ()=>{
    buildWeekSelect();
    renderPatternEditor();
  });
  $("weekSelect").addEventListener("change", renderPatternEditor);

  $("newPatternBtn").addEventListener("click", async ()=>{
    if (!state.me || state.me.role!=="admin") return;
    const ok = await openModal({title:"Nuevo patr√≥n", body:'<label>Nombre</label><input id="np_name" style="width:100%" placeholder="Patr√≥n nuevo"/><div class="small muted" style="margin-top:6px">Luego podr√°s cambiar el ciclo y asignar turnos.</div>', okText:"Crear"});
    if (!ok) return;
    const name = document.getElementById("np_name").value.trim() || "Patr√≥n";
    await addDoc(collection(DB,"patterns"), sanitize({
      name,
      cycleWeeks: 2,
      effectiveFrom: isoDate(mondayOfWeek(new Date())),
      active: false,
      weeks: [],
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }));
    await addDoc(collection(DB,"auditLogs"), sanitize({ at: serverTimestamp(), who: state.me.uid, action:"pattern_create", name }));
  });

  // Editor: tabla d√≠a x usuario
  function renderPatternEditor(){
    const box = $("patternEditor");
    const totalsBox = $("patternTotals");
    if (!box || !state.me || state.me.role!=="admin") return;
    if (!state.activePattern){ box.innerHTML = '<div class="muted">No hay patr√≥n.</div>'; totalsBox.textContent=""; return; }

    const cycle = Number($("cycleWeeks").value || state.activePattern.cycleWeeks || 2);
    const weekIdx = Number($("weekSelect").value || 0);

    // Asegurar estructura weeks
    const p = state.activePattern;
    const weeks = Array.isArray(p.weeks) ? JSON.parse(JSON.stringify(p.weeks)) : [];
    while (weeks.length < cycle){
      weeks.push({ days: Array.from({length:7}, (_,i)=>({ name: ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][i], assignments: {} })) });
    }
    for (let w=0; w<weeks.length; w++){
      if (!weeks[w].days || weeks[w].days.length !== 7){
        weeks[w].days = Array.from({length:7}, (_,i)=>({ name: ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][i], assignments: {} }));
      }
    }

    const users = [...state.usersByUid.values()].filter(u=>u.active!==false);
    const shiftOptions = state.shifts.filter(s=>s.active!==false);

    // Backfill assignmentsByEmail -> uid assignments (si existen emails)
    for (let w=0; w<weeks.length; w++){
      for (let d=0; d<7; d++){
        const day = weeks[w].days[d];
        if (day.assignmentsByEmail && !day.assignments){
          day.assignments = {};
          for (const [email,label] of Object.entries(day.assignmentsByEmail)){
            const uid = [...state.usersByUid.values()].find(u=>u.email===email)?.id;
            const shId = state.shifts.find(s=>s.label===label)?.id;
            if (uid && shId) day.assignments[uid] = shId;
          }
          delete day.assignmentsByEmail;
        }
        day.assignments ||= {};
      }
    }

    const dayRows = weeks[weekIdx].days.map((day, di)=>{
      const cells = users.map(u=>{
        const cur = day.assignments[u.id] || "";
        return `
          <td>
            <select data-pat-uid="${u.id}" data-pat-day="${di}" style="width:100%">
              <option value="">(vac√≠o)</option>
              ${shiftOptions.map(sh=>`<option value="${sh.id}" ${cur===sh.id?"selected":""}>${escapeHtml(sh.label)}</option>`).join("")}
            </select>
          </td>`;
      }).join("");
      return `
        <tr>
          <td style="font-weight:800">${day.name}</td>
          ${cells}
        </tr>`;
    }).join("");

    box.innerHTML = `
      <div class="muted small" style="margin-bottom:8px">Editando: <b>${escapeHtml(p.name)}</b> ¬∑ Semana ${weekIdx+1}/${cycle}</div>
      <table>
        <thead>
          <tr>
            <th>D√≠a</th>
            ${users.map(u=>`<th>${escapeHtml(u.name||u.email)}</th>`).join("")}
          </tr>
        </thead>
        <tbody>${dayRows}</tbody>
      </table>
      <div class="row" style="justify-content:flex-end">
        <button id="savePatternWeekBtn">Guardar cambios de esta semana</button>
      </div>`;

    $("savePatternWeekBtn").addEventListener("click", async ()=>{
      const selects = box.querySelectorAll("select[data-pat-uid]");
      for (const s of selects){
        const uid = s.getAttribute("data-pat-uid");
        const di = Number(s.getAttribute("data-pat-day"));
        const val = s.value || "";
        if (val) weeks[weekIdx].days[di].assignments[uid] = val;
        else delete weeks[weekIdx].days[di].assignments[uid];
      }

      // validar horas vs objetivos
      const issues = computePatternIssues(weeks, users, cycle);
      if (issues.length){
        beep();
        const ok1 = await openModal({
          title:"Horas descuadradas",
          body: "<div class='small'>Hay descuadres respecto a las horas objetivo:</div><ul>" + issues.map(x=>`<li><b>${escapeHtml(x.user)}</b>: ${escapeHtml(x.detail)}</li>`).join("") + "</ul><div class='small muted'>Puedes volver a editar o guardar igualmente.</div>",
          okText:"Continuar (guardar)",
          cancelText:"Volver a editar"
        });
        if (!ok1) return;
        beep();
        const ok2 = await openModal({
          title:"Confirmaci√≥n final",
          body:"Vas a guardar un patr√≥n con horas que no respetan el objetivo. ¬øSeguro seguro?",
          okText:"S√≠, guardar igualmente",
          cancelText:"No"
        });
        if (!ok2) return;
      }

      const effectiveFrom = $("patternEffectiveFrom").value || isoDate(mondayOfWeek(new Date()));
      const patch = {
        cycleWeeks: cycle,
        effectiveFrom,
        weeks,
        updatedAt: serverTimestamp()
      };
      await updateDoc(doc(DB,"patterns", p.id), sanitize(patch));
      await addDoc(collection(DB,"auditLogs"), sanitize({ at: serverTimestamp(), who: state.me.uid, action:"pattern_update", patternId:p.id }));
    });

    // Totales
    const totals = computePatternTotals(weeks, users, cycle);
    totalsBox.innerHTML = totals.map(t=>`<div>‚Ä¢ <b>${escapeHtml(t.user)}</b>: promedio ciclo ${fmtHM(t.avgMin)} / objetivo ${fmtHM(t.goalMin)} ¬∑ (semana 1: ${fmtHM(t.weeks[0]||0)} ‚Ä¶)</div>`).join("");
  }

  function computePatternTotals(weeks, users, cycle){
    const byShiftId = new Map(state.shifts.map(s=>[s.id,s]));
    return users.map(u=>{
      const perWeek = Array.from({length:cycle}, ()=>0);
      for (let w=0; w<cycle; w++){
        for (let d=0; d<7; d++){
          const shId = weeks[w]?.days?.[d]?.assignments?.[u.id] || null;
          const sh = shId ? byShiftId.get(shId) : null;
          perWeek[w] += shiftDurationMinutes(sh);
        }
      }
      const total = perWeek.reduce((a,x)=>a+x,0);
      const avg = total / Math.max(1,cycle);
      return { user: u.name||u.email, weeks: perWeek, totalMin: total, avgMin: avg, goalMin: (u.weeklyGoalHours||0)*60 };
    });
  }

  function computePatternIssues(weeks, users, cycle){
    const totals = computePatternTotals(weeks, users, cycle);
    const issues = [];
    for (const t of totals){
      const diff = Math.round(t.avgMin - t.goalMin);
      if (Math.abs(diff) >= 1){
        const txt = diff>0 ? `te sobran ${fmtHM(diff)} (promedio del ciclo)` : `te faltan ${fmtHM(-diff)} (promedio del ciclo)`;
        issues.push({ user: t.user, detail: txt });
      }
    }
    return issues;
  }

  $("applyPatternBtn").addEventListener("click", async ()=>{
    if (!state.me || state.me.role!=="admin") return;
    const id = $("patternSelect").value;
    if (!id) return;
    const ok = await openModal({title:"Activar patr√≥n", body:"Este patr√≥n ser√° el activo para generar el horario. ¬øActivar?", okText:"Activar"});
    if (!ok) return;

    const batch = writeBatch(DB);
    for (const p of state.patterns){
      batch.update(doc(DB,"patterns", p.id), sanitize({ active: p.id===id, updatedAt: serverTimestamp() }));
    }
    await batch.commit();
    await addDoc(collection(DB,"auditLogs"), sanitize({ at: serverTimestamp(), who: state.me.uid, action:"pattern_activate", patternId:id }));
  });

  // ========= SCHEDULE RENDER =========
  function renderSchedule(){
    const grid = $("scheduleGrid");
    if (!grid) return;
    if (!state.activePattern){
      grid.innerHTML = '<div class="muted">No hay patr√≥n activo.</div>';
      return;
    }

    const users = [...state.usersByUid.values()].filter(u=>u.active!==false);
    if (!users.length){ grid.innerHTML = '<div class="muted">No hay usuarios activos.</div>'; return; }

    const p = state.activePattern;
    const cycle = Number(p.cycleWeeks||2);
    const weeks = Array.isArray(p.weeks) ? p.weeks : [];
    const eff = p.effectiveFrom ? new Date(p.effectiveFrom+"T00:00:00") : mondayOfWeek(new Date());
    const effMon = mondayOfWeek(eff);

    // 4 semanas desde lunes actual
    const baseMon = mondayOfWeek(new Date());
    const days = [];
    for (let i=0;i<28;i++) days.push(addDays(baseMon,i));

    const shiftById = new Map(state.shifts.map(s=>[s.id,s]));

    // tabla por d√≠a
    const blocks = [];
    for (let w=0; w<4; w++){
      const wStart = addDays(baseMon, w*7);
      const label = `Semana ${isoDate(wStart)} ‚Üí ${isoDate(addDays(wStart,6))}`;
      const rows = [];
      for (let d=0; d<7; d++){
        const day = addDays(wStart, d);
        const dayISO = isoDate(day);
        const wkIndexAbs = Math.floor((mondayOfWeek(day) - effMon)/ (7*24*3600*1000));
        const wkIndex = ((wkIndexAbs % cycle)+cycle)%cycle;
        const weekObj = weeks[wkIndex] || {days:[]};
        const dayObj = weekObj.days?.[d] || {assignments:{}};

        const cols = users.map(u=>{
          if (isOnVacation(u.id, dayISO)) return '<span class="badge warn">Vacaciones</span>';
          const shId = dayObj.assignments?.[u.id] || null;
          const sh = shId ? shiftById.get(shId) : null;
          if (!sh) return '<span class="muted">‚Äî</span>';
          if (sh.isOff || (!sh.start && !sh.end)) return '<span class="muted">Libre</span>';
          return `<div><b>${escapeHtml(sh.label)}</b><div class="muted small">${escapeHtml(sh.start||"")}‚Äì${escapeHtml(sh.end||"")}</div></div>`;
        }).join("</td><td>");

        rows.push(`
          <tr>
            <td><b>${["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"][d]}</b><div class="muted small">${dayISO}</div></td>
            <td>${cols}</td>
          </tr>`.replace("<td>"+cols+"</td>", "<td>"+cols+"</td>"));
      }

      // render as a table with first col day, then each user col
      const head = users.map(u=>`<th>${escapeHtml(u.name||u.email)}</th>`).join("");
      const body = Array.from({length:7}, (_,d)=>{
        const day = addDays(wStart, d);
        const dayISO = isoDate(day);
        const wkIndexAbs = Math.floor((mondayOfWeek(day) - effMon)/ (7*24*3600*1000));
        const wkIndex = ((wkIndexAbs % cycle)+cycle)%cycle;
        const weekObj = weeks[wkIndex] || {days:[]};
        const dayObj = weekObj.days?.[d] || {assignments:{}};

        const tds = users.map(u=>{
          if (isOnVacation(u.id, dayISO)) return `<td><span class="badge warn">Vacaciones</span></td>`;
          const shId = dayObj.assignments?.[u.id] || null;
          const sh = shId ? shiftById.get(shId) : null;
          if (!sh) return `<td><span class="muted">‚Äî</span></td>`;
          if (sh.isOff || (!sh.start && !sh.end)) return `<td><span class="muted">Libre</span></td>`;
          return `<td><div><b>${escapeHtml(sh.label)}</b><div class="muted small">${escapeHtml(sh.start||"")}‚Äì${escapeHtml(sh.end||"")}</div></div></td>`;
        }).join("");

        return `
          <tr>
            <td style="font-weight:800">${["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][d]}
              <div class="muted small">${dayISO}</div>
            </td>
            ${tds}
          </tr>`;
      }).join("");

      blocks.push(`
        <div class="card" style="padding:10px">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:900">${label}</div>
            <div class="muted small">Patr√≥n: ${escapeHtml(p.name||"")}</div>
          </div>
          <div class="hr"></div>
          <table>
            <thead><tr><th>D√≠a</th>${head}</tr></thead>
            <tbody>${body}</tbody>
          </table>
        </div>`);
    }

    grid.innerHTML = blocks.join("");
  }

  $("refreshScheduleBtn").addEventListener("click", renderSchedule);

  // ========= TABS =========
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id = t.getAttribute("data-tab");
      ["tabSchedule","tabVacation","tabTasks","tabTime","tabAdmin"].forEach(s=>{
        const el = document.getElementById(s);
        if (!el) return;
        if (s===id) el.classList.remove("hidden"); else el.classList.add("hidden");
      });
      // refresh some views when entering
      if (id==="tabTime") updateMyStatusUI();
      if (id==="tabSchedule") renderSchedule();
      if (id==="tabAdmin") { renderUsersAdmin(); renderShiftAdmin(); renderPatternAdmin(); renderAudit(); }
    });
  });

  // ========= AUDIT =========
  function renderAudit(){
    const box = $("auditList");
    if (!box || !state.me || state.me.role!=="admin") return;
    const logs = state.auditLogs || [];
    if (!logs.length){ box.innerHTML = '<div class="muted">Sin registros.</div>'; return; }
    box.innerHTML = logs.map(l=>{
      const who = state.usersByUid.get(l.who)?.name || l.who || "‚Äî";
      return `
        <div class="card" style="padding:10px;margin-bottom:10px">
          <div style="font-weight:800">${escapeHtml(l.action||"")}</div>
          <div class="muted small">por ${escapeHtml(who)} ¬∑ ${escapeHtml(l.at?.toDate ? l.at.toDate().toLocaleString() : "")}</div>
        </div>`;
    }).join("");
  }

  // ========= ESCAPING =========
  function escapeHtml(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll('"',"&quot;");
  }

  // ========= BOOT =========
  onAuthStateChanged(AUTH, async (user)=>{
    if (!user){
      clearSubs();
      state.me = null;
      $("userPill").textContent = "No conectado";
      hide($("logoutBtn"));
      hide($("adminTabBtn"));
      hide($("adminVacCard"));
      hide($("adminTimeCard"));
      show($("loginView"));
      hide($("appView"));
      return;
    }

    show($("appView"));
    hide($("loginView"));

    // Seeds + migration (solo una vez)
    await ensureSeeds();
    await maybeMigrateFromGlobalState();

    // profile
    await upsertUserProfile(user);

    // Realtime
    startRealtime();

    // Pre-fill share select
    renderUserSelects();
    renderSchedule();
    renderTasks();
    renderVacations();
    renderMyTime();
    renderAdminTime();
    renderSummaries();
    renderLiveStatus();
  });

  // Auto-recalculate my status every 15s (para el cron√≥metro visual)
  setInterval(()=>{ if (state.me) updateMyStatusUI(); }, 15000);
</script>
</body>
</html>
